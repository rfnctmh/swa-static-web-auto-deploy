name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'build-info.json'
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      - master
  schedule:
    - cron: "0 0 * * *"  # 每天 00:00 UTC，自動部署一次（台灣時間 08:00）
  workflow_dispatch:
    inputs:
      source:
        description: "Trigger source (azure/gcp/manual/other)"
        required: false
        default: "manual"

jobs:
  build_and_deploy_job:
    # push 一定要跑；PR 要在沒被關閉時跑；排程也要跑；手動也要跑
    if: github.event_name == 'push' ||
        (github.event_name == 'pull_request' && github.event.action != 'closed') ||
        github.event_name == 'schedule' ||
        github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false
      - name: Update build-info.json
        run: |
          EVENT_NAME="${{ github.event_name }}"
          SOURCE_INPUT="${{ github.event.inputs.source }}"
          TS="$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')"

          # 如果檔案不存在就先初始化
          if [ ! -f build-info.json ]; then
            echo '{"push":null,"schedule":null,"other":null}' > build-info.json
          fi

          KEY=""
          LABEL=""

          if [ "$EVENT_NAME" = "push" ]; then
            KEY="push"
            LABEL="Build: $TS Source: GitHub Push"
          elif [ "$EVENT_NAME" = "schedule" ]; then
            KEY="schedule"
            LABEL="Build: $TS Source: Daily Schedule"
          else
            # 其餘全部歸類到 other（Cloud Function / Azure / 手動 / PR…）
            KEY="other"

            if [ "$EVENT_NAME" = "workflow_dispatch" ] && [ -n "$SOURCE_INPUT" ]; then
              # 例如 Source: Cloud Function / Azure / manual
              LABEL="Build: $TS Source: $SOURCE_INPUT"
            else
              LABEL="Build: $TS Source: $EVENT_NAME"
            fi
          fi

          echo "Update key=$KEY with: $LABEL"

          tmp=$(mktemp)
          jq --arg key "$KEY" --arg val "$LABEL" '.[$key] = $val' build-info.json > "$tmp"
          mv "$tmp" build-info.json

      - name: Commit build-info.json
        if: github.actor != 'github-actions[bot]'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add build-info.json
          git commit -m "chore(build): update build-info for ${{ github.event_name }}" || echo "No changes to commit"
          git push

      # 「自動部署寫檔」，
      - name: Write build time file
        run: |
          mkdir -p site

          EVENT_NAME="${{ github.event_name }}"
          SOURCE_INPUT="${{ github.event.inputs.source }}"

          # 先決定 SOURCE：有帶 inputs.source 就用它，否則用 event_name
          if [ "$EVENT_NAME" = "workflow_dispatch" ] && [ -n "$SOURCE_INPUT" ]; then
            SOURCE="$SOURCE_INPUT"
          else
            SOURCE="$EVENT_NAME"
          fi

          TS="$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')"

          # 預設顯示文字
          LABEL="$SOURCE"

          # 依來源決定要寫哪個檔案
          case "$SOURCE" in
            push)
              LABEL="GitHub Push"
              TARGET_FILE="site/build_push.txt"
              ;;

            schedule)
              LABEL="Daily Schedule"
              TARGET_FILE="site/build_schedule.txt"
              ;;

            *)
              # 其他來源（例如 workflow_dispatch: azure/gcp/manual）
              # 才會寫到 build.txt
              TARGET_FILE="site/build.txt"
              ;;
          esac

          echo "Build: $TS Source: $LABEL" > "$TARGET_FILE"


      # Azure 預設那段：先拿 OIDC token 給後面的 action 用
      - name: Install OIDC Client from Core Package
        run: npm install @actions/core@1.6.0 @actions/http-client

      - name: Get Id Token
        id: idtoken
        uses: actions/github-script@v6
        with:
          script: |
            const coredemo = require('@actions/core')
            return await coredemo.getIDToken()
          result-encoding: string

      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          # 這裡請換成你 Azure 那個實際產生的 secret 名稱
          # 例如：AZURE_STATIC_WEB_APPS_API_TOKEN_CALM_SKY_0AC47E700
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "upload"

          # ===== 專案路徑設定 =====
          app_location: "site"     # 你的前端原始碼目錄
          api_location: ""         # 沒有 API 就空著
          output_location: ""      # 你沒有額外 build 目錄就空著
          # 若你真的要「完全不讓它幫你 build」，可打開這行
          skip_app_build: true

          # OIDC 給 Azure 用
          github_id_token: ${{ steps.idtoken.outputs.result }}
          # =======================

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          action: "close"
